# Raffle Module

–ú–æ–¥—É–ª—å –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π –ø—Ä–∏–∑–æ–≤.

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

- `core` ‚Äî –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

## –û–ø–∏—Å–∞–Ω–∏–µ

–ê–¥–º–∏–Ω —Å–æ–∑–¥–∞—ë—Ç —Ä–æ–∑—ã–≥—Ä—ã—à, –¥–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–∏–∑—ã, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è, –∑–∞–ø—É—Å–∫–∞–µ—Ç.
–ü–æ–±–µ–¥–∏—Ç–µ–ª–∏ –≤—ã–±–∏—Ä–∞—é—Ç—Å—è —Å–ª—É—á–∞–π–Ω–æ –ø–æ –±–∏–ª–µ—Ç–∞–º.

---

## –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞

- **–ó–∞–ø—É—Å–∫:** —Ç–æ–ª—å–∫–æ –≤—Ä—É—á–Ω—É—é –∞–¥–º–∏–Ω–æ–º
- **–í—ã–±–æ—Ä –ø–æ–±–µ–¥–∏—Ç–µ–ª—è:** —Ä–∞–Ω–¥–æ–º –ø–æ –±–∏–ª–µ—Ç–∞–º (–±–æ–ª—å—à–µ –±–∏–ª–µ—Ç–æ–≤ = –±–æ–ª—å—à–µ —à–∞–Ω—Å)
- **–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –≤—ã–∏–≥—Ä—ã—à–∏:** —Ä–∞–∑—Ä–µ—à–µ–Ω—ã (–æ–¥–∏–Ω —é–∑–µ—Ä –º–æ–∂–µ—Ç –≤—ã–∏–≥—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∏–∑–æ–≤)
- **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:** –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ª–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
- **–ü—Ä–∏–∑—ã:** –Ω–∞–∑–≤–∞–Ω–∏–µ + –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (–∑–∞–¥–∞—ë—Ç –∞–¥–º–∏–Ω)

### –¢–∏–ø—ã —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π

| –¢–∏–ø | –ë–∏–ª–µ—Ç—ã –ø–æ—Å–ª–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----|--------------|----------|
| `intermediate` | –°–≥–æ—Ä–∞—é—Ç | –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π |
| `final` | –ù–µ –≤–∞–∂–Ω–æ | –§–∏–Ω–∞–ª—å–Ω—ã–π |

---

## –ü—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ (–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å)

### –®–∞–≥ 1: –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| –ù–∞–∑–≤–∞–Ω–∏–µ | text | "–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π —Ä–æ–∑—ã–≥—Ä—ã—à #3" |
| –¢–∏–ø | select | –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π / –§–∏–Ω–∞–ª—å–Ω—ã–π |
| –°–∂–µ—á—å –±–∏–ª–µ—Ç—ã | checkbox | –û–±–Ω—É–ª–∏—Ç—å –±–∏–ª–µ—Ç—ã –ø–æ—Å–ª–µ (–¥–ª—è –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö) |

### –®–∞–≥ 2: –ü—Ä–∏–∑—ã
| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–∑–∞ | text | "iPhone 16 Pro" |
| –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ | number | 1 |
| –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ | file | –ö–∞—Ä—Ç–∏–Ω–∫–∞ –ø—Ä–∏–∑–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) |

### –®–∞–≥ 3: –°–æ–æ–±—â–µ–Ω–∏—è ‚≠ê
| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—é | textarea | "üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏: {prize}..." |
| –°–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ–∏–≥—Ä–∞–≤—à–µ–º—É | textarea | "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤ —ç—Ç–æ—Ç —Ä–∞–∑ –Ω–µ –ø–æ–≤–µ–∑–ª–æ..." |
| –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø—Ä–æ–∏–≥—Ä–∞–≤—à–∏–º | checkbox | –£–≤–µ–¥–æ–º–ª—è—Ç—å —Ç–µ—Ö, –∫—Ç–æ –Ω–µ –≤—ã–∏–≥—Ä–∞–ª |

**–ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–±–µ–¥–∏—Ç–µ–ª—é:**
- `{prize}` ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–∑–∞
- `{name}` ‚Äî –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `{tickets}` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∏–ª–µ—Ç–æ–≤ –±—ã–ª–æ

---

## –ü–æ—Ä—è–¥–æ–∫ –æ–ø–µ—Ä–∞—Ü–∏–π –ø—Ä–∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–∏

```
1. –ê–¥–º–∏–Ω –Ω–∞–∂–∏–º–∞–µ—Ç "–ü—Ä–æ–≤–µ—Å—Ç–∏ —Ä–æ–∑—ã–≥—Ä—ã—à"
   ‚Üì
2. –í–∞–ª–∏–¥–∞—Ü–∏—è:
   - –ï—Å—Ç—å –ª–∏ –ø—Ä–∏–∑—ã? 
   - –ï—Å—Ç—å –ª–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∏ —Å –±–∏–ª–µ—Ç–∞–º–∏?
   ‚Üì
3. –í—ã–±–æ—Ä –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π (—Ä–∞–Ω–¥–æ–º –ø–æ –±–∏–ª–µ—Ç–∞–º)
   ‚Üì
4. –°–û–•–†–ê–ù–ï–ù–ò–ï –í –ë–î ‚Üê —Ç–æ—á–∫–∞ –Ω–µ–≤–æ–∑–≤—Ä–∞—Ç–∞
   - –°—Ç–∞—Ç—É—Å —Ä–æ–∑—ã–≥—Ä—ã—à–∞ = "completed"
   - –ü–æ–±–µ–¥–∏—Ç–µ–ª–∏ –∑–∞–ø–∏—Å–∞–Ω—ã
   ‚Üì
5. –ê–¥–º–∏–Ω –°–†–ê–ó–£ –≤–∏–¥–∏—Ç —Å–ø–∏—Å–æ–∫ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π ‚úÖ
   ‚Üì
6. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
   - –ü–æ–±–µ–¥–∏—Ç–µ–ª—è–º
   - –ü—Ä–æ–∏–≥—Ä–∞–≤—à–∏–º (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ)
```

---

## Edge Cases

### –ë–æ—Ç —É–ø–∞–ª –≤–æ –≤—Ä–µ–º—è —Ä–∞—Å—Å—ã–ª–∫–∏
- –ü–æ–±–µ–¥–∏—Ç–µ–ª–∏ —É–∂–µ –≤ –±–∞–∑–µ (—à–∞–≥ 4)
- –ü–æ–ª–µ `notified` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫—Ç–æ —É–≤–µ–¥–æ–º–ª—ë–Ω
- –ö–Ω–æ–ø–∫–∞ "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É" –¥–ª—è –Ω–µ—É–≤–µ–¥–æ–º–ª—ë–Ω–Ω—ã—Ö

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞
- –°—Ç–∞—Ç—É—Å `notified = "blocked"`
- –í–∏–¥–Ω–æ –≤ –ø–∞–Ω–µ–ª–∏: "–ú–∞—Ä–∏—è (–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∞ –±–æ—Ç–∞)"

### –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –Ω–∞ "–ü—Ä–æ–≤–µ—Å—Ç–∏"
- –†–æ–∑—ã–≥—Ä—ã—à —Å `status = completed` –Ω–µ–ª—å–∑—è –ø—Ä–æ–≤–µ—Å—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ
- –ö–Ω–æ–ø–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞

### –ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- –û—à–∏–±–∫–∞: "–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å –±–∏–ª–µ—Ç–∞–º–∏"
- –†–æ–∑—ã–≥—Ä—ã—à –æ—Å—Ç–∞—ë—Ç—Å—è `pending`

### –ü—Ä–∏–∑–æ–≤ –±–æ–ª—å—à–µ —á–µ–º –±–∏–ª–µ—Ç–æ–≤
- –†–∞–∑—ã–≥—Ä—ã–≤–∞–µ–º —Å–∫–æ–ª—å–∫–æ –º–æ–∂–µ–º
- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: "5 –∏–∑ 14 –ø—Ä–∏–∑–æ–≤ —Ä–∞–∑—ã–≥—Ä–∞–Ω–æ"

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–∏–≥—Ä–∞–ª –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∏–∑–æ–≤
- –ü–æ–ª—É—á–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ –ø—Ä–∏–∑)
- –ò–ª–∏ –æ–¥–Ω–æ —Å–≤–æ–¥–Ω–æ–µ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)

---

## –°—Ç–∞—Ç—É—Å—ã —Ä–æ–∑—ã–≥—Ä—ã—à–∞

| –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ | –î–µ–π—Å—Ç–≤–∏—è |
|--------|----------|----------|
| `pending` | –°–æ–∑–¥–∞–Ω | –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–∑–æ–≤ |
| `in_progress` | –ò–¥—ë—Ç —Ä–∞—Å—Å—ã–ª–∫–∞ | –ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ |
| `completed` | –ó–∞–≤–µ—Ä—à—ë–Ω | –ü—Ä–æ—Å–º–æ—Ç—Ä, —ç–∫—Å–ø–æ—Ä—Ç, –ø–æ–≤—Ç–æ—Ä —Ä–∞—Å—Å—ã–ª–∫–∏ |

---

## Handlers (–±–æ—Ç)

| Trigger | Handler | Description |
|---------|---------|-------------|
| `üéü –ú–æ–∏ –±–∏–ª–µ—Ç—ã` | `show_tickets` | –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∏–ª–µ—Ç–æ–≤ |

## –ö–Ω–æ–ø–∫–∞ –º–µ–Ω—é

```python
menu_buttons = [
    {"text": "üéü –ú–æ–∏ –±–∏–ª–µ—Ç—ã", "order": 30}
]
```

---

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ `raffles`
```sql
CREATE TABLE raffles (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    type VARCHAR(20) DEFAULT 'final',
    status VARCHAR(20) DEFAULT 'pending',
    burn_tickets BOOLEAN DEFAULT FALSE,
    winner_message TEXT,          -- —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—é
    loser_message TEXT,           -- —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ–∏–≥—Ä–∞–≤—à–µ–º—É
    notify_losers BOOLEAN DEFAULT FALSE,
    held_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### –¢–∞–±–ª–∏—Ü–∞ `raffle_prizes`
```sql
CREATE TABLE raffle_prizes (
    id SERIAL PRIMARY KEY,
    raffle_id INT REFERENCES raffles(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    quantity INT DEFAULT 1,
    image_path TEXT
);
```

### –¢–∞–±–ª–∏—Ü–∞ `raffle_winners`
```sql
CREATE TABLE raffle_winners (
    id SERIAL PRIMARY KEY,
    raffle_id INT REFERENCES raffles(id),
    prize_id INT REFERENCES raffle_prizes(id),
    user_id INT REFERENCES users(id),
    ticket_number INT,
    notified VARCHAR(20) DEFAULT 'pending',  -- pending, sent, blocked, failed
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

## –°–æ–±—ã—Ç–∏—è

### –ò—Å–ø—É—Å–∫–∞–µ—Ç
- `raffle.conducted` ‚Äî `{ raffle_id, winners_count }`
- `raffle.winner_selected` ‚Äî `{ user_id, prize_name }`
- `raffle.notifications_completed` ‚Äî `{ raffle_id, sent, failed }`

### –°–ª—É—à–∞–µ—Ç
- `promo.code_activated` ‚Äî –¥–æ–±–∞–≤–ª—è–µ—Ç –±–∏–ª–µ—Ç—ã
- `receipts.receipt_approved` ‚Äî –¥–æ–±–∞–≤–ª—è–µ—Ç –±–∏–ª–µ—Ç—ã

---

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–∞–Ω–µ–ª—å—é

| Endpoint | –ú–µ—Ç–æ–¥ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-------|----------|
| `/api/raffles` | GET | –°–ø–∏—Å–æ–∫ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π |
| `/api/raffles` | POST | –°–æ–∑–¥–∞—Ç—å —Ä–æ–∑—ã–≥—Ä—ã—à |
| `/api/raffles/{id}` | PUT | –û–±–Ω–æ–≤–∏—Ç—å (–Ω–∞–∑–≤–∞–Ω–∏–µ, —Å–æ–æ–±—â–µ–Ω–∏—è) |
| `/api/raffles/{id}/prizes` | POST | –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–∑ |
| `/api/raffles/{id}/conduct` | POST | –ü—Ä–æ–≤–µ—Å—Ç–∏ —Ä–æ–∑—ã–≥—Ä—ã—à |
| `/api/raffles/{id}/winners` | GET | –°–ø–∏—Å–æ–∫ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π |
| `/api/raffles/{id}/resend` | POST | –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É |
| `/api/raffles/{id}/export` | GET | –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel |
