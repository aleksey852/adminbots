{% extends "base.html" %}

{% block content %}
<div class="page-header-premium">
    <div class="title-area">
        <h1>ü§ñ –ê–∫—Ç–∏–≤–∞—Ü–∏—è –±–æ—Ç–∞</h1>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –µ–≥–æ —Ç–æ–∫–µ–Ω–æ–º</p>
    </div>
    <div class="action-area">
        <a href="/" class="btn btn-outline-light text-body border-0 btn-sm d-flex align-items-center">
            <i class="bi bi-arrow-left me-1"></i> –ù–∞–∑–∞–¥
        </a>
    </div>
</div>

<div class="container-fluid p-0">
    {% if error %}
    <div class="alert alert-danger mb-4">
        <i class="bi bi-exclamation-circle me-2"></i> {{ error }}
    </div>
    {% endif %}

    {% if not bot_templates %}
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="bi bi-folder-x display-1 text-muted mb-3"></i>
            <h4>–®–∞–±–ª–æ–Ω–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h4>
            <p class="text-muted">
                –ü–∞–ø–∫–∞ <code>bots/</code> –ø—É—Å—Ç–∞ –∏–ª–∏ —à–∞–±–ª–æ–Ω—ã –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç <code>manifest.json</code>
            </p>
        </div>
    </div>
    {% else %}
    <div class="row g-4">
        {% for template in bot_templates %}
        <div class="col-md-6 col-lg-4">
            <div class="card h-100 template-card {{ 'border-success' if template.is_active else '' }}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">{{ template.display_name }}</h5>
                    {% if template.is_active %}
                    <span class="badge badge-success">
                        <i class="bi bi-check-circle me-1"></i>–ê–∫—Ç–∏–≤–µ–Ω
                    </span>
                    {% else %}
                    <span class="badge badge-secondary">v{{ template.version }}</span>
                    {% endif %}
                </div>
                <div class="card-body">
                    <p class="text-muted small">{{ template.description or '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è' }}</p>

                    <div class="mb-3">
                        <span class="text-muted small">–ú–æ–¥—É–ª–∏:</span>
                        <div class="d-flex flex-wrap gap-1 mt-1">
                            {% for module in template.modules %}
                            <span class="badge badge-primary border">{{ module }}</span>
                            {% endfor %}
                        </div>
                    </div>

                    {% if template.is_active %}
                    <a href="/bots/{{ template.active_bot_id }}/edit" class="btn btn-outline-primary btn-sm w-100">
                        <i class="bi bi-gear me-1"></i>–ù–∞—Å—Ç—Ä–æ–π–∫–∏
                    </a>
                    {% else %}
                    <button class="btn btn-primary btn-sm w-100"
                        onclick="showActivateModal('{{ template.path }}', '{{ template.display_name }}')">
                        <i class="bi bi-play-circle me-1"></i>–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<!-- Activation Modal -->
<div class="modal fade" id="activateModal" tabindex="-1" aria-labelledby="activateModalLabel" aria-hidden="true"
    style="z-index: 9999;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form method="POST" action="/bots/create">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <input type="hidden" name="template_path" id="templatePath" value="">

                <div class="modal-header">
                    <h5 class="modal-title" id="activateModalLabel">üöÄ –ê–∫—Ç–∏–≤–∞—Ü–∏—è –±–æ—Ç–∞</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">
                        –®–∞–±–ª–æ–Ω: <strong id="templateName"></strong>
                    </p>

                    <div class="mb-3">
                        <label for="bot_name" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –±–æ—Ç–∞ (–¥–ª—è –ø–∞–Ω–µ–ª–∏)</label>
                        <input type="text" class="form-control" id="bot_name" name="bot_name" required
                            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –õ–µ—Ç–Ω—è—è –∞–∫—Ü–∏—è 2025">
                        <div class="form-text">–≠—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ –ø–∞–Ω–µ–ª–∏</div>
                    </div>

                    <div class="mb-3">
                        <label for="token" class="form-label">Bot Token (–∏–∑ @BotFather)</label>
                        <input type="text" class="form-control font-monospace" id="token" name="token" required
                            placeholder="123456789:ABCdefGHIjklMNOpqrs...">
                        <div class="form-text">–¢–æ–∫–µ–Ω –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —É @BotFather</div>
                    </div>

                    <div class="mb-3">
                        <label for="admin_ids" class="form-label">ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                        <input type="text" class="form-control" id="admin_ids" name="admin_ids"
                            placeholder="123456789, 987654321">
                        <div class="form-text">–ß–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é. –£–∑–Ω–∞—Ç—å ID: <code>@userinfobot</code></div>
                    </div>

                    <hr class="my-3">
                    <h6 class="mb-3"><i class="bi bi-megaphone me-1"></i>–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª</h6>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="require_subscription"
                            name="require_subscription" onchange="toggleChannelInput(this)">
                        <label class="form-check-label" for="require_subscription">
                            –¢—Ä–µ–±–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ –∫–∞–Ω–∞–ª
                        </label>
                    </div>

                    <div class="mb-3" id="channelInputBlock" style="display: none;">
                        <label for="channel_id" class="form-label">ID –∫–∞–Ω–∞–ª–∞ (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏)</label>
                        <input type="text" class="form-control" id="channel_id" name="channel_id"
                            placeholder="-1001234567890">
                        <div class="form-text">–ë–æ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –∫–∞–Ω–∞–ª–∞. –ü–æ–ª—É—á–∏—Ç—å ID: @userinfobot</div>
                    </div>

                    <div class="mb-3" id="channelUrlBlock" style="display: none;">
                        <label for="channel_url" class="form-label">–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª (–¥–ª—è –∫–Ω–æ–ø–∫–∏)</label>
                        <input type="text" class="form-control" id="channel_url" name="channel_url"
                            placeholder="https://t.me/my_channel">
                        <div class="form-text">–ü—É–±–ª–∏—á–Ω–∞—è —Å—Å—ã–ª–∫–∞ –∏–ª–∏ invite-link</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-rocket me-1"></i>–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Backdrop Fix -->
<div class="modal-backdrop-custom" id="modalBackdrop" style="display: none;"></div>
{% endblock %}

{% block extra_css %}
<style>
    .template-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .template-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .template-card.border-success {
        border-color: var(--success) !important;
    }

    /* Modal z-index fix */
    .modal {
        z-index: 10050 !important;
    }

    .modal-backdrop {
        z-index: 10040 !important;
    }

    .modal-dialog {
        z-index: 10060 !important;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    let activateModal;

    document.addEventListener('DOMContentLoaded', function () {
        // Move modal to body to fix z-index/backdrop issues
        const modalEl = document.getElementById('activateModal');
        if (modalEl) {
            document.body.appendChild(modalEl);

            activateModal = new bootstrap.Modal(modalEl, {
                backdrop: true,
                keyboard: true,
                focus: true
            });
        }
    });

    function showActivateModal(templatePath, templateName) {
        document.getElementById('templatePath').value = templatePath;
        document.getElementById('templateName').textContent = templateName;
        document.getElementById('bot_name').value = '';
        document.getElementById('token').value = '';
        document.getElementById('admin_ids').value = '';
        document.getElementById('require_subscription').checked = false;
        document.getElementById('channel_id').value = '';
        document.getElementById('channel_url').value = '';
        document.getElementById('channelInputBlock').style.display = 'none';
        document.getElementById('channelUrlBlock').style.display = 'none';
        activateModal.show();
    }

    function toggleChannelInput(checkbox) {
        const show = checkbox.checked ? 'block' : 'none';
        document.getElementById('channelInputBlock').style.display = show;
        document.getElementById('channelUrlBlock').style.display = show;
    }
</script>
{% endblock %}