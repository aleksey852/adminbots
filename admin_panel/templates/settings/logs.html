{% extends "base.html" %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <h1 class="page-title"><i class="bi bi-journal-text"></i> Логи системы</h1>
    <div class="d-flex gap-2">
        <button id="autoRefreshBtn" class="btn btn-outline-secondary btn-sm" title="Авто-обновление каждые 5 сек">
            <i class="bi bi-arrow-repeat"></i> <span id="autoRefreshLabel">Авто</span>
        </button>
        <button id="copyLogsBtn" class="btn btn-outline-secondary btn-sm" title="Скопировать логи">
            <i class="bi bi-clipboard"></i> Копировать
        </button>
        <a href="/settings/logs?service={{ active_service }}&lines={{ lines }}" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-arrow-clockwise"></i> Обновить
        </a>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <ul class="nav nav-tabs mb-3">
            <li class="nav-item">
                <a class="nav-link {% if active_service == 'admin_bots' %}active{% endif %}"
                    href="/settings/logs?service=admin_bots{% if q %}&q={{ q }}{% endif %}{% if active_level %}&level={{ active_level }}{% endif %}&lines={{ lines }}">
                    <i class="bi bi-robot"></i> Боты (admin_bots)
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if active_service == 'admin_panel' %}active{% endif %}"
                    href="/settings/logs?service=admin_panel{% if q %}&q={{ q }}{% endif %}{% if active_level %}&level={{ active_level }}{% endif %}&lines={{ lines }}">
                    <i class="bi bi-layout-sidebar"></i> Панель (admin_panel)
                </a>
            </li>
        </ul>

        <div class="card shadow-sm mb-4 border-0">
            <div class="card-body p-3">
                <form method="get" action="/settings/logs" class="row g-3">
                    <input type="hidden" name="service" value="{{ active_service }}">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0"><i
                                    class="bi bi-search text-muted"></i></span>
                            <input type="text" name="q" class="form-control border-start-0"
                                placeholder="Поиск в логах (grep)..." value="{{ q or '' }}">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select name="level" class="form-select">
                            <option value="">Все уровни</option>
                            <option value="error" {% if active_level=='error' %}selected{% endif %}>Ошибки (Error)
                            </option>
                            <option value="warning" {% if active_level=='warning' %}selected{% endif %}>Предупреждения
                                (Warning)</option>
                            <option value="info" {% if active_level=='info' %}selected{% endif %}>Инфо (Info)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select name="lines" class="form-select">
                            <option value="50" {% if lines==50 %}selected{% endif %}>50 строк</option>
                            <option value="100" {% if lines==100 %}selected{% endif %}>100 строк</option>
                            <option value="200" {% if lines==200 %}selected{% endif %}>200 строк</option>
                            <option value="500" {% if lines==500 %}selected{% endif %}>500 строк</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-filter"></i> Применить
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card shadow-sm border-0 bg-dark">
            <div
                class="card-header bg-dark text-light border-secondary d-flex justify-content-between align-items-center">
                <span><i class="bi bi-terminal"></i> Последние {{ lines }} строк</span>
                <div class="d-flex align-items-center gap-2">
                    <small class="text-muted">journalctl -n {{ lines }} -u {{ active_service }}</small>
                    <button id="scrollBottomBtn" class="btn btn-outline-light btn-sm" title="Прокрутить вниз">
                        <i class="bi bi-arrow-down"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <pre id="logsContainer" class="m-0 p-3 text-light font-monospace small"
                    style="max-height: 70vh; overflow-y: auto; white-space: pre-wrap;">{{ logs }}</pre>
            </div>
        </div>

        <div class="mt-3 text-muted small">
            <i class="bi bi-info-circle"></i> Логи отображаются из системного менеджера journald.
            <span id="autoRefreshStatus" class="ms-2" style="display: none;">
                <i class="bi bi-clock"></i> Следующее обновление через <span id="countdown">5</span> сек
            </span>
        </div>
    </div>
</div>

<style>
    #logsContainer .log-error {
        color: #ff6b6b;
        font-weight: 500;
    }

    #logsContainer .log-warning {
        color: #ffc107;
    }

    #logsContainer .log-info {
        color: #69db7c;
    }

    #logsContainer .log-debug {
        color: #868e96;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const logsContainer = document.getElementById('logsContainer');
        const autoRefreshBtn = document.getElementById('autoRefreshBtn');
        const autoRefreshLabel = document.getElementById('autoRefreshLabel');
        const autoRefreshStatus = document.getElementById('autoRefreshStatus');
        const countdownEl = document.getElementById('countdown');
        const copyLogsBtn = document.getElementById('copyLogsBtn');
        const scrollBottomBtn = document.getElementById('scrollBottomBtn');

        let autoRefreshEnabled = false;
        let refreshInterval = null;
        let countdownInterval = null;
        let countdown = 5;

        // Colorize logs
        function colorizeLogs() {
            const content = logsContainer.innerHTML;
            const lines = content.split('\n');
            const coloredLines = lines.map(line => {
                if (line.includes('ERROR') || line.includes('error') || line.includes('CRITICAL')) {
                    return `<span class="log-error">${line}</span>`;
                } else if (line.includes('WARNING') || line.includes('warning') || line.includes('warn')) {
                    return `<span class="log-warning">${line}</span>`;
                } else if (line.includes('INFO') || line.includes('info')) {
                    return `<span class="log-info">${line}</span>`;
                } else if (line.includes('DEBUG') || line.includes('debug')) {
                    return `<span class="log-debug">${line}</span>`;
                }
                return line;
            });
            logsContainer.innerHTML = coloredLines.join('\n');
        }
        colorizeLogs();

        // Scroll to bottom
        scrollBottomBtn.addEventListener('click', function () {
            logsContainer.scrollTop = logsContainer.scrollHeight;
        });

        // Copy logs
        copyLogsBtn.addEventListener('click', function () {
            const text = logsContainer.textContent;
            navigator.clipboard.writeText(text).then(() => {
                copyLogsBtn.innerHTML = '<i class="bi bi-check"></i> Скопировано';
                setTimeout(() => {
                    copyLogsBtn.innerHTML = '<i class="bi bi-clipboard"></i> Копировать';
                }, 2000);
            });
        });

        // Auto-refresh toggle
        autoRefreshBtn.addEventListener('click', function () {
            autoRefreshEnabled = !autoRefreshEnabled;
            if (autoRefreshEnabled) {
                autoRefreshBtn.classList.remove('btn-outline-secondary');
                autoRefreshBtn.classList.add('btn-success');
                autoRefreshLabel.textContent = 'Авто ON';
                autoRefreshStatus.style.display = 'inline';
                countdown = 5;
                countdownEl.textContent = countdown;

                countdownInterval = setInterval(() => {
                    countdown--;
                    countdownEl.textContent = countdown;
                    if (countdown <= 0) countdown = 5;
                }, 1000);

                refreshInterval = setInterval(() => {
                    window.location.reload();
                }, 5000);
            } else {
                autoRefreshBtn.classList.remove('btn-success');
                autoRefreshBtn.classList.add('btn-outline-secondary');
                autoRefreshLabel.textContent = 'Авто';
                autoRefreshStatus.style.display = 'none';
                clearInterval(refreshInterval);
                clearInterval(countdownInterval);
            }
        });
    });
</script>
{% endblock %}