{% extends "base.html" %}

{% block content %}
<div class="page-header-premium">
    <div class="title-area">
        <h1>Системные Логи</h1>
        <p>Мониторинг активности и диагностика</p>
    </div>
    <div class="actions-area d-flex gap-2">
        <div class="btn-group" role="group">
            <a href="?service=admin_bots&lines={{ lines }}"
                class="btn {% if active_service == 'admin_bots' %}btn-primary{% else %}btn-secondary{% endif %}">
                <i class="bi bi-robot me-2"></i>Bots
            </a>
            <a href="?service=admin_panel&lines={{ lines }}"
                class="btn {% if active_service == 'admin_panel' %}btn-primary{% else %}btn-secondary{% endif %}">
                <i class="bi bi-window-desktop me-2"></i>Panel
            </a>
        </div>
    </div>
</div>

<div class="container-fluid px-0">
    <!-- Toolbar -->
    <div class="logs-toolbar">
        <form method="GET" class="row g-3 align-items-center">
            <input type="hidden" name="service" value="{{ active_service }}">

            <div class="col-lg-5 col-md-6">
                <div class="input-group">
                    <span class="input-group-text border-end-0">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" class="form-control border-start-0 ps-0" name="q" value="{{ q or '' }}"
                        placeholder="Поиск по логам (grep)...">
                </div>
            </div>

            <div class="col-lg-2 col-md-3">
                <select class="form-select" name="level">
                    <option value="">Все уровни</option>
                    <option value="ERROR" {% if active_level=='ERROR' %}selected{% endif %}>ERROR</option>
                    <option value="WARNING" {% if active_level=='WARNING' %}selected{% endif %}>WARNING</option>
                    <option value="INFO" {% if active_level=='INFO' %}selected{% endif %}>INFO</option>
                </select>
            </div>

            <div class="col-lg-2 col-md-3">
                <select class="form-select" name="lines">
                    <option value="50" {% if lines==50 %}selected{% endif %}>50 строк</option>
                    <option value="100" {% if lines==100 %}selected{% endif %}>100 строк</option>
                    <option value="200" {% if lines==200 %}selected{% endif %}>200 строк</option>
                    <option value="500" {% if lines==500 %}selected{% endif %}>500 строк</option>
                </select>
            </div>

            <div class="col-lg-3 col-md-12 d-flex gap-2 align-items-center">
                <div class="form-check form-switch" title="Авто-обновление каждые 3 сек">
                    <input class="form-check-input" type="checkbox" id="autoUpdate" checked>
                </div>
                <button type="submit" class="btn btn-primary flex-grow-1">
                    <i class="bi bi-arrow-clockwise me-2"></i>Обновить
                </button>
                <button type="button" class="btn btn-secondary"
                    onclick="window.scrollTo(0, document.body.scrollHeight)">
                    <i class="bi bi-arrow-down"></i>
                </button>
            </div>
        </form>
    </div>

    <!-- Terminal Window -->
    <div class="terminal-window">
        <div class="terminal-header">
            <div class="d-flex align-items-center gap-3">
                <div class="terminal-controls">
                    <div class="terminal-dot red"></div>
                    <div class="terminal-dot yellow"></div>
                    <div class="terminal-dot green"></div>
                </div>
                <div class="text-muted small font-monospace">
                    {{ active_service }}.service &mdash; bash &mdash; {{ lines }} lines
                </div>
            </div>
            <div class="text-muted small">
                <!-- Additional status info could go here -->
            </div>
        </div>
        <div class="terminal-body" id="terminalOutput">
            {% if logs %}
            {% for line in logs.split('\n') %}
            {% if line.strip() %}
            {% set lower_line = line.lower() %}
            {% set class = 'info' %}
            {% if 'error' in lower_line or 'exception' in lower_line or 'traceback' in lower_line %}
            {% set class = 'error' %}
            {% elif 'warning' in lower_line %}
            {% set class = 'warning' %}
            {% endif %}
            <div class="log-line {{ class }}">{{ line }}</div>
            {% endif %}
            {% endfor %}
            {% else %}
            <div class="log-line text-muted fst-italic p-4 text-center">Нет логов для отображения или сервис не запущен.
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const terminal = document.getElementById('terminalOutput');
        const autoUpdateCheck = document.getElementById('autoUpdate');

        // Auto-scroll on initial load
        if (terminal && !window.location.search.includes('q=')) {
            terminal.scrollTop = terminal.scrollHeight;
        }

        // Auto-update logic
        setInterval(() => {
            if (!autoUpdateCheck.checked) return;

            const urlParams = new URLSearchParams(window.location.search);
            const params = {
                service: urlParams.get('service') || 'admin_bots',
                q: urlParams.get('q') || '',
                level: urlParams.get('level') || '',
                lines: urlParams.get('lines') || '100'
            };

            fetch(`/settings/logs/json?${new URLSearchParams(params)}`)
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'ok' && data.logs) {
                        const wasAtBottom = terminal.scrollHeight - terminal.scrollTop <= terminal.clientHeight + 50;

                        // Parse and render lines
                        const lines = data.logs.split('\n');
                        const html = lines.map(line => {
                            if (!line.trim()) return '';
                            const lower = line.toLowerCase();
                            let cls = 'info';
                            if (lower.includes('error') || lower.includes('exception') || lower.includes('traceback')) cls = 'error';
                            else if (lower.includes('warning')) cls = 'warning';
                            return `<div class="log-line ${cls}">${line}</div>`;
                        }).join('');

                        // Only update if changes (simple length check optimization possible, but replace is safer)
                        if (terminal.innerHTML !== html) {
                            terminal.innerHTML = html || '<div class="log-line text-muted fst-italic p-4 text-center">Нет данных</div>';
                            if (wasAtBottom) terminal.scrollTop = terminal.scrollHeight;
                        }
                    }
                })
                .catch(e => console.error("Auto-update failed", e));
        }, 3000); // 3 seconds interval
    });
</script>
{% endblock %}