{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h1 class="page-title"><i class="bi bi-fonts"></i> Тексты сообщений</h1>
    <div class="text-muted">Редактирование всех текстов бота. Изменения применяются автоматически.</div>
</div>

<div class="row">
    <!-- Sidebar / Nav Pills for Categories -->
    <div class="col-md-3">
        <div class="card">
            <div class="card-header">Категории</div>
            <div class="list-group list-group-flush" id="text-categories" role="tablist">
                {% for group in groups %}
                <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center {% if loop.first %}active{% endif %}"
                    id="list-{{ loop.index }}-list" data-bs-toggle="list" href="#list-{{ loop.index }}" role="tab">
                    {{ group.name }}
                    <span class="badge bg-secondary rounded-pill">{{ group.items|length }}</span>
                </a>
                {% endfor %}
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-body">
                <small class="text-muted">
                    <b>Совет:</b> Используйте переменные в фигурных скобках, например <code>{name}</code>, чтобы бот
                    подставил имя пользователя. <br><br>
                    Если вы удалите текст, будет использоваться значение по умолчанию.
                </small>
            </div>
        </div>
    </div>

    <!-- Content -->
    <div class="col-md-9">
        <div class="tab-content" id="nav-tabContent">
            {% for group in groups %}
            <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="list-{{ loop.index }}"
                role="tabpanel">

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">{{ group.name }}</h3>
                    </div>
                    <div class="card-body">
                        {% for item in group.items %}
                        <div class="mb-4 pb-3 border-bottom item-row" id="row-{{ item.key }}">
                            <div class="d-flex justify-content-between mb-2">
                                <label class="form-label fw-bold font-monospace text-primary">{{ item.key }}</label>
                                {% if item.is_modified %}
                                <span class="badge bg-warning text-dark status-badge">Изменено</span>
                                {% else %}
                                <span class="badge bg-light text-muted status-badge">По умолчанию</span>
                                {% endif %}
                            </div>

                            <form class="text-form" data-key="{{ item.key }}">
                                <input type="hidden" name="key" value="{{ item.key }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

                                <div class="position-relative">
                                    <textarea class="form-control" name="text" rows="3"
                                        placeholder="{{ item.default }}">{{ item.value }}</textarea>

                                    <div class="d-flex justify-content-end mt-2 gap-2">
                                        <button type="button" class="btn btn-sm btn-outline-secondary btn-reset"
                                            title="Сбросить к стандартному" {% if not item.is_modified %}disabled{%
                                            endif %}>
                                            <i class="bi bi-arrow-counterclockwise"></i> Сбросить
                                        </button>
                                        <button type="submit" class="btn btn-sm btn-primary btn-save">
                                            <i class="bi bi-check-lg"></i> Сохранить
                                        </button>
                                    </div>
                                </div>
                            </form>

                            <div class="mt-2 text-muted small">
                                <strong>По умолчанию:</strong><br>
                                <span class="text-break fst-italic">{{ item.default }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Save Handler
        document.querySelectorAll('.text-form').forEach(form => {
            form.addEventListener('submit', async function (e) {
                e.preventDefault();
                const btn = form.querySelector('.btn-save');
                const originalText = btn.innerHTML;
                const row = form.closest('.item-row');
                const badge = row.querySelector('.status-badge');
                const resetBtn = row.querySelector('.btn-reset');

                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

                const formData = new FormData(form);

                try {
                    const response = await fetch('/texts/update', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.status === 'ok') {
                        // Show success
                        btn.classList.remove('btn-primary');
                        btn.classList.add('btn-success');
                        btn.innerHTML = '<i class="bi bi-check-lg"></i> Сохранено';

                        // Update badge
                        badge.className = 'badge bg-warning text-dark status-badge';
                        badge.textContent = 'Изменено';

                        // Enable reset
                        resetBtn.disabled = false;

                        setTimeout(() => {
                            btn.classList.remove('btn-success');
                            btn.classList.add('btn-primary');
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                        }, 2000);
                    } else {
                        alert('Ошибка: ' + (result.error || 'Unknown error'));
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                } catch (err) {
                    console.error(err);
                    alert('Ошибка соединения');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            });
        });

        // Reset Handler
        document.querySelectorAll('.btn-reset').forEach(btn => {
            btn.addEventListener('click', async function () {
                if (!confirm('Сбросить текст к значению по умолчанию?')) return;

                const form = btn.closest('form');
                const key = form.querySelector('input[name="key"]').value;
                const csrf = form.querySelector('input[name="csrf_token"]').value;
                const textarea = form.querySelector('textarea');
                const row = form.closest('.item-row');
                const badge = row.querySelector('.status-badge');

                const formData = new FormData();
                formData.append('key', key);
                formData.append('csrf_token', csrf);

                btn.disabled = true;

                try {
                    const response = await fetch('/texts/reset', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.status === 'ok') {
                        // Update UI
                        textarea.value = textarea.placeholder;

                        badge.className = 'badge bg-light text-muted status-badge';
                        badge.textContent = 'По умолчанию';

                        btn.disabled = true;
                    } else {
                        alert('Ошибка: ' + result.error);
                        btn.disabled = false;
                    }
                } catch (err) {
                    console.error(err);
                    alert('Ошибка соединения');
                    btn.disabled = false;
                }
            });
        });
    });
</script>

<style>
    .list-group-item.active {
        background-color: var(--bs-primary);
        border-color: var(--bs-primary);
    }

    .text-form textarea {
        font-size: 0.95rem;
    }
</style>
{% endblock %}