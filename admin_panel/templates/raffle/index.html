{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h1 class="page-title"><i class="bi bi-gift"></i> –†–æ–∑—ã–≥—Ä—ã—à</h1>
</div>

{% if created %}
<div class="alert alert-success-custom mb-4">
    <i class="bi bi-check-circle"></i> –†–æ–∑—ã–≥—Ä—ã—à #{{ created }} —Å–æ–∑–¥–∞–Ω –∏ –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ–¥—ë–Ω –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é!
</div>
{% endif %}

<div class="row g-4">
    <div class="col-md-7">
        <div class="card">
            <div class="card-header"><i class="bi bi-plus-circle"></i> –ü—Ä–æ–≤–µ—Å—Ç–∏ —Ä–æ–∑—ã–≥—Ä—ã—à</div>
            <div class="card-body">
                {% if participants == 0 %}
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> –ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞. –£—á–∞—Å—Ç–Ω–∏–∫–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ
                    {% if bot.type == 'promo' %}–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤{% else %}–∑–∞–≥—Ä—É–∑–∫–∏ –≤–∞–ª–∏–¥–Ω—ã—Ö —á–µ–∫–æ–≤{% endif %}.
                </div>
                {% else %}
                <form method="post" action="/raffle/create" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <div class="alert alert-info-custom mb-4">
                        <i class="bi bi-people"></i> –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: <strong>{{ participants }}</strong>
                        {% if total_tickets %}<br><i class="bi bi-ticket-perforated"></i> –í—Å–µ–≥–æ –±–∏–ª–µ—Ç–æ–≤: <strong>{{
                            total_tickets }}</strong>{% endif %}
                    </div>

                    <div class="mb-3">
                        <label class="form-label">–ü—Ä–∏–∑—ã</label>
                        <div id="prizesContainer">
                            <div class="card mb-2 prize-row border-light bg-light">
                                <div class="card-body p-2">
                                    <div class="d-flex align-items-center mb-2">
                                        <span class="badge bg-secondary me-2 index-badge">1</span>
                                        <input type="text" class="form-control me-2" name="prize_names"
                                            placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–∑–∞" required>
                                        <input type="number" class="form-control me-2" name="winner_counts"
                                            placeholder="–ö–æ–ª-–≤–æ" value="1" min="1" style="max-width: 100px;" required>
                                        <button type="button" class="btn btn-outline-danger btn-sm remove-prize"
                                            disabled><i class="bi bi-trash"></i></button>
                                    </div>
                                    <input type="text" class="form-control form-control-sm mb-2" name="prize_msgs"
                                        placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—é (–∑–∞–º–µ–Ω—è–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ)">
                                    <input type="file" class="form-control form-control-sm" name="prize_photo_0"
                                        accept="image/*">
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addPrizeRow()">
                            <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–∑
                        </button>
                    </div>

                    <script>
                        function addPrizeRow() {
                            const container = document.getElementById('prizesContainer');
                            const count = container.children.length + 1;
                            const div = document.createElement('div');
                            div.className = 'card mb-2 prize-row border-light bg-light';
                            div.innerHTML = `
                                <div class="card-body p-2">
                                    <div class="d-flex align-items-center mb-2">
                                        <span class="badge bg-secondary me-2 index-badge">${count}</span>
                                        <input type="text" class="form-control me-2" name="prize_names" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–∑–∞" required>
                                        <input type="number" class="form-control me-2" name="winner_counts" placeholder="–ö–æ–ª-–≤–æ" value="1" min="1" style="max_width: 100px;" required>
                                        <button type="button" class="btn btn-outline-danger btn-sm remove-prize" onclick="removePrizeRow(this)"><i class="bi bi-trash"></i></button>
                                    </div>
                                    <input type="text" class="form-control form-control-sm mb-2" name="prize_msgs" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—é (–∑–∞–º–µ–Ω—è–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ)">
                                    <input type="file" class="form-control form-control-sm" name="prize_photo_${count - 1}" accept="image/*">
                                </div>
                            `;
                            container.appendChild(div);
                            updatePrizeNumbers();
                        }

                        function removePrizeRow(btn) {
                            btn.closest('.prize-row').remove();
                            updatePrizeNumbers();
                        }

                        function updatePrizeNumbers() {
                            const rows = document.querySelectorAll('.prize-row');
                            rows.forEach((row, index) => {
                                row.querySelector('.index-badge').innerText = (index + 1);
                                const photoInput = row.querySelector('input[type="file"]');
                                if (photoInput) {
                                    photoInput.name = `prize_photo_${index}`;
                                }
                                const btn = row.querySelector('.remove-prize');
                                if (index === 0) {
                                    btn.disabled = true;
                                    btn.removeAttribute('onclick');
                                } else {
                                    btn.disabled = false;
                                    btn.onclick = function () { removePrizeRow(this); };
                                }
                            });
                        }
                    </script>

                    <hr class="my-4">
                    <h6 class="mb-3"><i class="bi bi-trophy text-success"></i> –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ü–û–ë–ï–î–ò–¢–ï–õ–Ø–ú</h6>
                    <p class="text-muted small">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –µ—Å–ª–∏ –¥–ª—è –ø—Ä–∏–∑–∞ –Ω–µ –∑–∞–¥–∞–Ω–æ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ/—Ñ–æ—Ç–æ.
                        –ï—Å–ª–∏ –≤ –ø—Ä–∏–∑–µ –∑–∞–¥–∞–Ω —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç –∏–ª–∏ —Ç–æ–ª—å–∫–æ —Ñ–æ—Ç–æ, –Ω–µ–¥–æ—Å—Ç–∞—é—â–∞—è —á–∞—Å—Ç—å –±–µ—Ä–µ—Ç—Å—è –æ—Ç—Å—é–¥–∞.</p>

                    <div class="mb-3">
                        <label class="form-label">–¢–µ–∫—Å—Ç</label>
                        <textarea name="win_text" class="form-control" rows="3"
                            placeholder="üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏..."></textarea>
                        <small class="text-muted">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">–§–æ—Ç–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è–º (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                        <input type="file" name="win_photo" class="form-control" accept="image/*">
                    </div>

                    <hr class="my-4">
                    <h6 class="mb-3"><i class="bi bi-emoji-frown text-secondary"></i> –°–æ–æ–±—â–µ–Ω–∏–µ –û–°–¢–ê–õ–¨–ù–´–ú</h6>

                    <div class="mb-3">
                        <label class="form-label">–¢–µ–∫—Å—Ç</label>
                        <textarea name="lose_text" class="form-control" rows="3"
                            placeholder="–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤ —ç—Ç–æ—Ç —Ä–∞–∑ —É–¥–∞—á–∞ –Ω–µ –Ω–∞ –≤–∞—à–µ–π —Å—Ç–æ—Ä–æ–Ω–µ..."></textarea>
                        <small class="text-muted">–ï—Å–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º, –ø—Ä–∏–¥—ë—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤—ã –Ω–µ
                            –≤—ã–∏–≥—Ä–∞–ª–∏"</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">–§–æ—Ç–æ –æ—Å—Ç–∞–ª—å–Ω—ã–º (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                        <input type="file" name="lose_photo" class="form-control" accept="image/*">
                    </div>

                    <hr class="my-4">

                    <div class="mb-4">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="is_final" id="isFinalRaffle"
                                value="true">
                            <label class="form-check-label" for="isFinalRaffle">
                                <strong>üèÜ –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–æ–∑—ã–≥—Ä—ã—à</strong>
                            </label>
                        </div>
                        <small class="text-muted">–°—Ä–µ–¥–∏ –í–°–ï–• –±–∏–ª–µ—Ç–æ–≤ (—á–µ–∫–∏ + –ø—Ä–æ–º–æ–∫–æ–¥—ã + —Ä—É—á–Ω—ã–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è)</small>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                        <input type="datetime-local" name="scheduled_for" class="form-control">
                        <small class="text-muted">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è.</small>
                    </div>

                    <button type="submit" class="btn btn-warning w-100">
                        <i class="bi bi-shuffle"></i> –°–æ–∑–¥–∞—Ç—å —Ä–æ–∑—ã–≥—Ä—ã—à
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-5">
        <div class="card">
            <div class="card-header"><i class="bi bi-trophy"></i> –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∏</div>
            <div class="card-body p-0">
                {% if recent_raffles %}
                {% for raffle in recent_raffles %}
                <div class="border-bottom p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <strong>{{ raffle.prize_name or '–†–æ–∑—ã–≥—Ä—ã—à' }}</strong>
                        <small class="text-muted">{{ raffle.completed_at.strftime('%d.%m.%Y') if raffle.completed_at
                            else raffle.created_at.strftime('%d.%m.%Y') }}</small>
                    </div>
                    <div class="text-muted small mb-2">
                        –ü–æ–±–µ–¥–∏—Ç–µ–ª–µ–π: {{ raffle.winners | length }}
                    </div>
                    {% for w in raffle.winners[:3] %}
                    <div class="small">
                        {% if w.notified %}‚úì{% else %}‚è≥{% endif %}
                        {{ w.full_name or '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' }}
                        {% if w.username %}<span class="text-muted">@{{ w.username }}</span>{% endif %}
                    </div>
                    {% endfor %}
                    {% if raffle.winners | length > 3 %}
                    <div class="small text-muted">... –∏ –µ—â—ë {{ raffle.winners | length - 3 }}</div>
                    {% endif %}
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="bi bi-trophy" style="font-size: 2rem;"></i>
                    <p class="mt-2 mb-0">–†–æ–∑—ã–≥—Ä—ã—à–µ–π –µ—â—ë –Ω–µ –±—ã–ª–æ</p>
                </div>
                {% endif %}
            </div>
            {% if recent_raffles %}
            <div class="card-footer bg-white">
                <a href="/winners" class="text-decoration-none">–í—Å–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª–∏ ‚Üí</a>
            </div>
            {% endif %}
        </div>

        <div class="card mt-4">
            <div class="card-header"><i class="bi bi-info-circle"></i> –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç</div>
            <div class="card-body">
                <ol class="mb-0">
                    <li>–°–∏—Å—Ç–µ–º–∞ –≤—ã–±–∏—Ä–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã—Ö –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π —Å—Ä–µ–¥–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</li>
                    <li>–ü–æ–±–µ–¥–∏—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç –ø–æ–∑–¥—Ä–∞–≤–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</li>
                    <li>–û—Å—Ç–∞–ª—å–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –ø–æ–ª—É—á–∞—é—Ç —É—Ç–µ—à–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</li>
                    <li>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏–∏</li>
                </ol>
            </div>
        </div>
    </div>
</div>
{% endblock %}