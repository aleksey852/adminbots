{% extends "base.html" %}

{% block content %}
<div class="page-header-premium">
    <div class="title-area">
        <h1>–†–æ–∑—ã–≥—Ä—ã—à</h1>
        <p>–ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –∫–æ–Ω–∫—É—Ä—Å–æ–≤ –∏ –≤—ã–±–æ—Ä –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π</p>
    </div>
</div>

{% if created %}
<div class="alert alert-success-custom mb-4">
    <i class="bi bi-check-circle"></i> –†–æ–∑—ã–≥—Ä—ã—à #{{ created }} —Å–æ–∑–¥–∞–Ω –∏ –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ–¥—ë–Ω –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é!
</div>
{% endif %}

<div class="row g-4">
    <div class="col-md-7">
        <div class="card">
            <div class="card-header"><i class="bi bi-plus-circle"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–∞</div>
            <div class="card-body">
                {% if participants == 0 %}
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> –ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞. –£—á–∞—Å—Ç–Ω–∏–∫–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ
                    {% if bot.type == 'promo' %}–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤{% else %}–∑–∞–≥—Ä—É–∑–∫–∏ –≤–∞–ª–∏–¥–Ω—ã—Ö —á–µ–∫–æ–≤{% endif %}.
                </div>
                {% else %}
                <form method="post" action="/raffle/create" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <div class="alert alert-info-custom mb-4">
                        <i class="bi bi-people"></i> –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: <strong>{{ participants }}</strong>
                        {% if total_tickets %}<br><i class="bi bi-ticket-perforated"></i> –í—Å–µ–≥–æ –±–∏–ª–µ—Ç–æ–≤: <strong>{{
                            total_tickets }}</strong>{% endif %}
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">üèÜ –ü—Ä–∏–∑–æ–≤—ã–µ –º–µ—Å—Ç–∞</label>
                        <div id="prizesContainer">
                            <div class="card mb-3 prize-row border shadow-sm">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="badge bg-warning text-dark rounded-circle me-3 d-flex align-items-center justify-content-center"
                                            style="width: 24px; height: 24px;">1</div>
                                        <div class="flex-grow-1">
                                            <input type="text" class="form-control fw-bold" name="prize_names"
                                                placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–∑–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, iPhone 15)" required>
                                        </div>
                                    </div>

                                    <div class="row g-2 mb-2">
                                        <div class="col-md-4">
                                            <label class="small text-muted mb-1">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π</label>
                                            <input type="number" class="form-control form-control-sm"
                                                name="winner_counts" placeholder="1" value="1" min="1" required>
                                        </div>
                                        <div class="col-md-8">
                                            <label class="small text-muted mb-1">–§–æ—Ç–æ –ø—Ä–∏–∑–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                                            <input type="file" class="form-control form-control-sm" name="prize_photo_0"
                                                accept="image/*">
                                        </div>
                                    </div>

                                    <div class="mt-2">
                                        <label class="small text-muted mb-1">–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—é</label>
                                        <textarea class="form-control form-control-sm" name="prize_msgs" rows="2"
                                            placeholder="–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ [–ø—Ä–∏–∑]! –°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏..."></textarea>
                                    </div>

                                    <div class="text-end mt-2">
                                        <button type="button" class="btn btn-outline-danger btn-sm remove-prize"
                                            disabled>–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–∑</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-primary w-100" onclick="addPrizeRow()">
                            <i class="bi bi-plus-lg me-1"></i> –î–æ–±–∞–≤–∏—Ç—å –µ—â–µ –ø—Ä–∏–∑–æ–≤–æ–µ –º–µ—Å—Ç–æ
                        </button>
                    </div>

                    <script>
                        function addPrizeRow() {
                            const container = document.getElementById('prizesContainer');
                            const count = container.children.length + 1;
                            const div = document.createElement('div');
                            div.className = 'card mb-3 prize-row border shadow-sm';
                            div.innerHTML = `
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="badge bg-secondary text-white rounded-circle me-3 d-flex align-items-center justify-content-center index-badge" style="width: 24px; height: 24px;">${count}</div>
                                        <div class="flex-grow-1">
                                            <input type="text" class="form-control fw-bold" name="prize_names" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–∑–∞" required>
                                        </div>
                                    </div>
                                    
                                    <div class="row g-2 mb-2">
                                        <div class="col-md-4">
                                            <label class="small text-muted mb-1">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π</label>
                                            <input type="number" class="form-control form-control-sm" name="winner_counts" placeholder="1" value="1" min="1" required>
                                        </div>
                                        <div class="col-md-8">
                                            <label class="small text-muted mb-1">–§–æ—Ç–æ –ø—Ä–∏–∑–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                                            <input type="file" class="form-control form-control-sm" name="prize_photo_${count - 1}" accept="image/*">
                                        </div>
                                    </div>
                                    
                                    <div class="mt-2">
                                        <label class="small text-muted mb-1">–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—é</label>
                                        <textarea class="form-control form-control-sm" name="prize_msgs" rows="2" placeholder="–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ [–ø—Ä–∏–∑]!"></textarea>
                                    </div>
                                    
                                    <div class="text-end mt-2">
                                        <button type="button" class="btn btn-outline-danger btn-sm remove-prize" onclick="removePrizeRow(this)">–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–∑</button>
                                    </div>
                                </div>
                            `;
                            container.appendChild(div);
                            updatePrizeNumbers();
                        }

                        function removePrizeRow(btn) {
                            btn.closest('.prize-row').remove();
                            updatePrizeNumbers();
                        }

                        function updatePrizeNumbers() {
                            const rows = document.querySelectorAll('.prize-row');
                            rows.forEach((row, index) => {
                                const badge = row.querySelector('.index-badge') || row.querySelector('.badge');
                                if (badge) {
                                    badge.innerText = (index + 1);
                                    if (index === 0) {
                                        badge.className = 'badge bg-warning text-dark rounded-circle me-3 d-flex align-items-center justify-content-center';
                                    } else {
                                        badge.className = 'badge bg-secondary text-white rounded-circle me-3 d-flex align-items-center justify-content-center index-badge';
                                    }
                                }

                                const photoInput = row.querySelector('input[type="file"]');
                                if (photoInput) {
                                    photoInput.name = `prize_photo_${index}`;
                                }
                                const btn = row.querySelector('.remove-prize');
                                if (index === 0) {
                                    btn.disabled = true;
                                    btn.removeAttribute('onclick');
                                    btn.style.display = 'none'; // Hide delete for first item
                                } else {
                                    btn.disabled = false;
                                    btn.style.display = 'inline-block';
                                    btn.onclick = function () { removePrizeRow(this); };
                                }
                            });
                        }
                    </script>

                    <hr class="my-4">
                    <h6 class="mb-3 text-muted fw-bold text-uppercase"
                        style="font-size: 0.8rem; letter-spacing: 0.05em;">–£—Ç–µ—à–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</h6>

                    <div class="mb-3">
                        <label class="form-label">–¢–µ–∫—Å—Ç –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ –Ω–µ –≤—ã–∏–≥—Ä–∞–ª</label>
                        <textarea name="lose_text" class="form-control" rows="3"
                            placeholder="–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤ —ç—Ç–æ—Ç —Ä–∞–∑ —É–¥–∞—á–∞ –Ω–µ –Ω–∞ –≤–∞—à–µ–π —Å—Ç–æ—Ä–æ–Ω–µ..."></textarea>
                        <small class="text-muted">–ï—Å–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º, –ø—Ä–∏–¥—ë—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">–ö–∞—Ä—Ç–∏–Ω–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                        <input type="file" name="lose_photo" class="form-control" accept="image/*">
                    </div>

                    <hr class="my-4">

                    <div class="mb-4 bg-surface p-3 rounded border">
                        <label class="form-label fw-bold mb-3">üé≤ –¢–∏–ø —Ä–æ–∑—ã–≥—Ä—ã—à–∞</label>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="raffle_type" id="raffleIntermediate"
                                value="intermediate" checked>
                            <label class="form-check-label" for="raffleIntermediate">
                                üîÑ <strong>–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Ä–æ–∑—ã–≥—Ä—ã—à</strong>
                            </label>
                            <div class="text-muted small ms-4">–ë–∏–ª–µ—Ç—ã —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ <strong>—Å–≥–æ—Ä–∞—é—Ç</strong> –ø–æ—Å–ª–µ
                                —Ä–æ–∑—ã–≥—Ä—ã—à–∞</div>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="raffle_type" id="raffleFinal"
                                value="final">
                            <label class="form-check-label" for="raffleFinal">
                                üèÜ <strong>–§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–æ–∑—ã–≥—Ä—ã—à</strong>
                            </label>
                            <div class="text-muted small ms-4">–°—Ä–µ–¥–∏ <strong>–í–°–ï–•</strong> –∞–∫—Ç–∏–≤–∞—Ü–∏–π –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è
                                (–±–∏–ª–µ—Ç—ã –Ω–µ —Å–≥–æ—Ä–∞—é—Ç)</div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">–ö–æ–≥–¥–∞ –ø—Ä–æ–≤–µ—Å—Ç–∏?</label>
                        <input type="datetime-local" name="scheduled_for" class="form-control">
                        <small class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –¥–ª—è –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∑–∞–ø—É—Å–∫–∞
                            –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.</small>
                    </div>

                    <button type="submit" class="btn btn-warning w-100 py-2 fw-bold">
                        <i class="bi bi-shuffle me-2"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–æ–∑—ã–≥—Ä—ã—à
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-5">
        <div class="card">
            <div class="card-header"><i class="bi bi-trophy"></i> –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∏</div>
            <div class="card-body p-0">
                {% if recent_raffles %}
                {% for raffle in recent_raffles %}
                <div class="border-bottom p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <strong>{{ raffle.prize_name or '–†–æ–∑—ã–≥—Ä—ã—à' }}</strong>
                        <small class="text-muted">{{ raffle.completed_at.strftime('%d.%m.%Y') if raffle.completed_at
                            else raffle.created_at.strftime('%d.%m.%Y') }}</small>
                    </div>
                    <div class="text-muted small mb-2">
                        –ü–æ–±–µ–¥–∏—Ç–µ–ª–µ–π: {{ raffle.winners | length }}
                    </div>
                    {% for w in raffle.winners[:3] %}
                    <div class="small">
                        {% if w.notified %}‚úì{% else %}‚è≥{% endif %}
                        {{ w.full_name or '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' }}
                        {% if w.username %}<span class="text-muted">@{{ w.username }}</span>{% endif %}
                    </div>
                    {% endfor %}
                    {% if raffle.winners | length > 3 %}
                    <div class="small text-muted">... –∏ –µ—â—ë {{ raffle.winners | length - 3 }}</div>
                    {% endif %}
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="bi bi-trophy" style="font-size: 2rem;"></i>
                    <p class="mt-2 mb-0">–†–æ–∑—ã–≥—Ä—ã—à–µ–π –µ—â—ë –Ω–µ –±—ã–ª–æ</p>
                </div>
                {% endif %}
            </div>
            {% if recent_raffles %}
            <div class="card-footer">
                <a href="/winners" class="text-decoration-none">–í—Å–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª–∏ ‚Üí</a>
            </div>
            {% endif %}
        </div>

        <div class="card mt-4">
            <div class="card-header"><i class="bi bi-info-circle"></i> –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç</div>
            <div class="card-body">
                <ol class="mb-0">
                    <li>–°–∏—Å—Ç–µ–º–∞ –≤—ã–±–∏—Ä–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã—Ö –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π —Å—Ä–µ–¥–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</li>
                    <li>–ü–æ–±–µ–¥–∏—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç –ø–æ–∑–¥—Ä–∞–≤–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</li>
                    <li>–û—Å—Ç–∞–ª—å–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –ø–æ–ª—É—á–∞—é—Ç —É—Ç–µ—à–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</li>
                    <li>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏–∏</li>
                </ol>
            </div>
        </div>
    </div>
</div>
{% endblock %}