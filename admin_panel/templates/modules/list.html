{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <div class="row align-items-center">
        <div class="col">
            <h1 class="page-title"><i class="bi bi-puzzle me-2"></i>Модули</h1>
            <div class="text-muted mt-1">Управление функционалом бота {{ bot.name }}</div>
        </div>
        <div class="col-auto">
            <a href="/bots/{{ bot.id }}/pipelines" class="btn btn-outline-primary">
                <i class="bi bi-diagram-3-fill me-1"></i> Настройка сценариев (Pipelines)
            </a>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body p-0">
        {% if modules %}
        <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle">
                <thead>
                    <tr>
                        <th style="width: 25%">Модуль</th>
                        <th style="width: 35%">Описание</th>
                        <th style="width: 15%" class="text-center">Статус</th>
                        <th style="width: 25%" class="text-end">Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for mod in modules %}
                    <tr class="{{ 'bg-light' if not mod.is_enabled else '' }}">
                        <td>
                            <div class="d-flex align-items-center">
                                <div
                                    class="avatar avatar-sm me-3 {{ 'bg-primary-subtle text-primary' if mod.is_enabled else 'bg-secondary-subtle text-secondary' }}">
                                    {{ mod.name[0]|upper }}
                                </div>
                                <div>
                                    <div class="fw-bold">{{ mod.name }}</div>
                                    <div class="small text-muted">v{{ mod.version }}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="text-truncate" style="max-width: 300px;" title="{{ mod.description }}">
                                {{ mod.description }}
                            </div>
                            {% if mod.dependencies %}
                            <div class="mt-1">
                                {% for dep in mod.dependencies %}
                                <span class="badge bg-secondary-subtle text-secondary" style="font-size: 0.7em">{{ dep
                                    }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if mod.is_enabled %}
                            <span
                                class="badge bg-success-subtle text-success border border-success-subtle">Включён</span>
                            {% else %}
                            <span
                                class="badge bg-secondary-subtle text-secondary border border-secondary-subtle">Выключен</span>
                            {% endif %}
                        </td>
                        <td class="text-end">
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-light border"
                                    onclick="openSettings('{{ mod.name }}')" {{ 'disabled' if not mod.is_enabled and not
                                    mod.settings }}>
                                    <i class="bi bi-gear"></i>
                                </button>

                                {% if mod.is_core %}
                                <button class="btn btn-sm btn-light border" disabled
                                    title="Core module cannot be disabled">
                                    <i class="bi bi-lock-fill text-muted"></i>
                                </button>
                                {% else %}
                                <button type="button"
                                    class="btn btn-sm {{ 'btn-outline-danger' if mod.is_enabled else 'btn-outline-success' }}"
                                    onclick="toggleModule('{{ mod.name }}', {{ 'false' if mod.is_enabled else 'true' }})">
                                    <i class="bi {{ 'bi-power' if mod.is_enabled else 'bi-play-fill' }}"></i>
                                    {{ 'Выкл' if mod.is_enabled else 'Вкл' }}
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="p-5 text-center text-muted">
            <div class="mb-3"><i class="bi bi-box display-4 text-secondary"></i></div>
            <h4>Нет модулей</h4>
            <p>Система не обнаружила загруженных модулей.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Настройки модуля <span id="settingsModalTitle"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="settingsForm">
                    <div id="settingsContainer">
                        <!-- Dynamic fields will be here -->
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="saveSettings()">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<script>
    const botId = {{ bot.id }};
    const allModules = {{ modules | tojson }};
    let currentModule = null;

    function toggleModule(moduleName, enable) {
        if (!confirm(enable ? `Включить модуль ${moduleName}?` : `Выключить модуль ${moduleName}?`)) return;

        fetch(`/bots/${botId}/modules/${moduleName}/toggle?enable=${enable}`, {
            method: 'POST',
            headers: {
                'X-CSRF-Token': '{{ csrf_token }}'
            }
        })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success') {
                    location.reload();
                } else {
                    alert('Ошибка: ' + (data.detail || 'Unknown error'));
                }
            });
    }

    function openSettings(moduleName) {
        const mod = allModules.find(m => m.name === moduleName);
        if (!mod) return;

        currentModule = mod;
        document.getElementById('settingsModalTitle').innerText = mod.name;
        const container = document.getElementById('settingsContainer');
        container.innerHTML = '';

        if (!mod.schema || Object.keys(mod.schema).length === 0) {
            container.innerHTML = '<p class="text-muted text-center py-3">У этого модуля нет настроек.</p>';
        } else {
            // Build form based on schema
            // Schema format: "key": { "type": "text", "label": "Label", "default": "", ... }
            for (const [key, schema] of Object.entries(mod.schema)) {
                const value = (mod.settings && mod.settings[key] !== undefined) ? mod.settings[key] : schema.default;

                const div = document.createElement('div');
                div.className = 'mb-3';

                const label = document.createElement('label');
                label.className = 'form-label';
                label.innerText = schema.label || key;
                div.appendChild(label);

                let input;

                if (schema.type === 'textarea') {
                    input = document.createElement('textarea');
                    input.className = 'form-control';
                    input.rows = 3;
                    input.value = value || '';
                } else if (schema.type === 'checkbox') {
                    input = document.createElement('input');
                    input.type = 'checkbox';
                    input.className = 'form-check-input ms-2';
                    input.checked = !!value;
                    // For checkbox, label usually goes after
                    label.appendChild(input);
                    // Don't append input separately
                } else if (schema.type === 'number') {
                    input = document.createElement('input');
                    input.type = 'number';
                    input.className = 'form-control';
                    input.value = value || 0;
                } else {
                    input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'form-control';
                    input.value = value || '';
                }

                input.dataset.key = key;
                input.dataset.type = schema.type;

                if (schema.type !== 'checkbox') {
                    div.appendChild(input);
                }

                container.appendChild(div);
            }
        }

        new bootstrap.Modal(document.getElementById('settingsModal')).show();
    }

    function saveSettings() {
        if (!currentModule) return;

        const settings = {};
        const container = document.getElementById('settingsContainer');
        const inputs = container.querySelectorAll('input, textarea, select');

        inputs.forEach(input => {
            const key = input.dataset.key;
            const type = input.dataset.type;
            if (!key) return;

            let val;
            if (type === 'checkbox') {
                val = input.checked;
            } else if (type === 'number') {
                val = Number(input.value);
            } else {
                val = input.value;
            }

            settings[key] = val;
        });

        fetch(`/bots/${botId}/modules/${currentModule.name}/settings`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': '{{ csrf_token }}'
            },
            body: JSON.stringify(settings)
        })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success') {
                    location.reload();
                } else {
                    alert('Ошибка при сохранении');
                }
            });
    }
</script>
{% endblock %}