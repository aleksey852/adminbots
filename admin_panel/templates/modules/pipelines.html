{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <div class="row align-items-center">
        <div class="col">
            <a href="/bots/{{ bot.id }}/modules" class="text-decoration-none text-muted mb-2 d-inline-block">
                <i class="bi bi-arrow-left"></i> Назад к модулям
            </a>
            <h1 class="page-title">Сценарии (Pipelines) bot {{ bot.name }}</h1>
        </div>
    </div>
</div>

<div class="row">
    <!-- Chains List -->
    <div class="col-md-3">
        <div class="card mb-3">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">Сценарии</h5>
            </div>
            <div class="list-group list-group-flush" id="chainsList">
                {% for chain in chains %}
                <a href="#" class="list-group-item list-group-item-action" onclick="loadChain('{{ chain }}', this)">
                    <div class="d-flex w-100 justify-content-between align-items-center">
                        <span class="fw-medium">{{ chain }}</span>
                        <i class="bi bi-chevron-right text-muted small"></i>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Interface Area -->
    <div class="col-md-9">
        <div class="card" id="editorCard" style="display:none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0" id="currentChainTitle">Редактор</h5>
                <button class="btn btn-sm btn-primary" id="saveOrderBtn" onclick="saveOrder()">
                    <i class="bi bi-save me-1"></i> Сохранить изменения
                </button>
            </div>
            <div class="card-body bg-light">
                <div class="row">
                    <!-- Available Steps (Source) -->
                    <div class="col-md-5">
                        <h6 class="text-uppercase text-muted small fw-bold mb-3">
                            <i class="bi bi-box-seam me-1"></i> Доступные шаги
                        </h6>
                        <div id="availableSteps" class="list-group min-vh-50 bg-white border rounded p-2 shadow-sm"
                            style="min-height: 400px;">
                            <!-- Items will be injected here -->
                        </div>
                    </div>

                    <!-- Arrow Separator -->
                    <div class="col-md-1 d-flex align-items-center justify-content-center">
                        <i class="bi bi-arrow-right display-6 text-muted opacity-25"></i>
                    </div>

                    <!-- Active Pipeline (Target) -->
                    <div class="col-md-6">
                        <h6 class="text-uppercase text-muted small fw-bold mb-3">
                            <i class="bi bi-list-ol me-1"></i> Активный сценарий
                        </h6>
                        <div id="activeSteps" class="list-group min-vh-50 bg-white border rounded p-2 shadow-sm"
                            style="min-height: 400px;">
                            <!-- Items will be injected here -->
                        </div>
                        <div class="form-text mt-2">
                            Перетащите шаги в этот список, чтобы добавить их в сценарий.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Placeholder -->
        <div class="card" id="placeholderCard">
            <div class="card-body py-5 text-center text-muted">
                <i class="bi bi-diagram-2 display-1 mb-3 d-block opacity-25"></i>
                <h5>Выберите сценарий слева</h5>
                <p>чтобы настроить порядок прохождения шагов</p>
            </div>
        </div>
    </div>
</div>

<!-- SortableJS for drag and drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
    const botId = {{ bot.id }};
    let currentChain = null;
    let sortableActive = null;
    let sortableAvailable = null;

    function loadChain(chainName, element) {
        if (element) {
            document.querySelectorAll('#chainsList .active').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
        }

        currentChain = chainName;
        document.getElementById('currentChainTitle').innerText = `Сценарий: ${chainName}`;

        // Show loading
        document.getElementById('editorCard').style.display = 'none';
        document.getElementById('placeholderCard').style.display = 'none';

        fetch(`/bots/${botId}/pipelines/${chainName}`)
            .then(r => r.json())
            .then(data => {
                document.getElementById('editorCard').style.display = 'block';
                renderLists(data.active_steps, data.available_steps);
            });
    }

    function renderLists(activeSteps, availableSteps) {
        const activeContainer = document.getElementById('activeSteps');
        const availableContainer = document.getElementById('availableSteps');

        activeContainer.innerHTML = '';
        availableContainer.innerHTML = '';

        function createStepEl(step, isActive) {
            const item = document.createElement('div');
            item.className = 'list-group-item p-3 mb-2 border rounded shadow-sm bg-white cursor-move step-item';
            // Use ID for tracking
            item.dataset.id = step.id;

            let badgeClass = 'bg-secondary';
            if (step.module_name === 'registration') badgeClass = 'bg-info text-dark';

            item.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="me-3 text-muted drag-handle"><i class="bi bi-grip-vertical"></i></div>
                    <div class="flex-grow-1">
                        <div class="fw-bold">${step.name}</div>
                        <div class="small text-muted">${step.description || step.id}</div>
                        <div class="mt-1">
                            <span class="badge ${badgeClass} border bg-opacity-10 text-dark opacity-75 small p-1 px-2 rounded-pill">
                                ${step.module_name}
                            </span>
                        </div>
                    </div>
                </div>
            `;
            return item;
        }

        activeSteps.forEach(s => activeContainer.appendChild(createStepEl(s, true)));
        availableSteps.forEach(s => availableContainer.appendChild(createStepEl(s, false)));

        initSortable();
    }

    function initSortable() {
        const activeContainer = document.getElementById('activeSteps');
        const availableContainer = document.getElementById('availableSteps');

        if (sortableActive) sortableActive.destroy();
        if (sortableAvailable) sortableAvailable.destroy();

        // Config for both
        const ops = {
            group: 'shared', // shared group allows dragging between lists
            animation: 150,
            ghostClass: 'bg-light',
            handle: '.step-item, .drag-handle', // Make whole item draggable usually better UX
            sort: true,
        };

        sortableActive = new Sortable(activeContainer, {
            ...ops,
            onSort: function (evt) {
                // Could verify something here
            }
        });

        sortableAvailable = new Sortable(availableContainer, {
            ...ops,
            sort: false // Usually don't need sorting in source list? But why not
        });
    }

    function saveOrder() {
        if (!currentChain) return;

        const list = document.getElementById('activeSteps');
        const steps = Array.from(list.children).map(el => el.dataset.id);

        const btn = document.getElementById('saveOrderBtn');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';

        fetch(`/bots/${botId}/pipelines/${currentChain}/order`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': '{{ csrf_token }}'
            },
            body: JSON.stringify(steps)
        })
            .then(r => r.json())
            .then(data => {
                btn.disabled = false;
                btn.innerHTML = originalText;
                if (data.status === 'success') {
                    const toast = document.createElement('div');
                    toast.className = 'position-fixed bottom-0 end-0 p-3';
                    toast.style.zIndex = 1050;
                    toast.innerHTML = `
                        <div class="toast show align-items-center text-white bg-success border-0">
                            <div class="d-flex">
                                <div class="toast-body">Pipeline saved successfully!</div>
                                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 3000);
                } else {
                    alert('Error saving order');
                }
            });
    }
</script>

<style>
    .cursor-move {
        cursor: move;
        /* fallback if grab cursor is unsupported */
        cursor: grab;
        cursor: -moz-grab;
        cursor: -webkit-grab;
    }

    .cursor-move:active {
        cursor: grabbing;
        cursor: -moz-grabbing;
        cursor: -webkit-grabbing;
    }
</style>
{% endblock %}