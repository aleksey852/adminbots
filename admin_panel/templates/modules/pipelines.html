{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <div class="row align-items-center">
        <div class="col">
            <a href="/bots/{{ bot.id }}/modules" class="text-decoration-none text-muted mb-2 d-inline-block">
                <i class="bi bi-arrow-left"></i> Назад к модулям
            </a>
            <h1 class="page-title">Сценарии (Pipelines) bot {{ bot.name }}</h1>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">Доступные сценарии</h5>
            </div>
            <div class="list-group list-group-flush" id="chainsList">
                {% for chain in chains %}
                <a href="#" class="list-group-item list-group-item-action" onclick="loadChain('{{ chain }}', this)">
                    <div class="d-flex w-100 justify-content-between align-items-center">
                        <span class="fw-medium">{{ chain }}</span>
                        <i class="bi bi-chevron-right text-muted small"></i>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0" id="currentChainTitle">Выберите сценарий</h5>
                <div>
                    <button class="btn btn-sm btn-outline-danger me-1" id="resetOrderBtn" style="display: none;"
                        onclick="resetOrder()">
                        <i class="bi bi-arrow-counterclockwise"></i> Сброс
                    </button>
                    <button class="btn btn-sm btn-primary" id="saveOrderBtn" style="display: none;"
                        onclick="saveOrder()">
                        <i class="bi bi-save me-1"></i> Сохранить порядок
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="stepsContainer" class="text-center text-muted py-5">
                    <i class="bi bi-diagram-3 display-4 mb-3 d-block opacity-25"></i>
                    Выберите цепочку шагов слева для настройки порядка.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SortableJS for drag and drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
    const botId = {{ bot.id }};
    let currentChain = null;
    let sortable = null;

    function loadChain(chainName, element) {
        if (element) {
            document.querySelectorAll('#chainsList .active').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
        }

        currentChain = chainName;
        document.getElementById('currentChainTitle').innerText = `Цепочка: ${chainName}`;
        const container = document.getElementById('stepsContainer');
        container.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';

        fetch(`/bots/${botId}/pipelines/${chainName}`)
            .then(r => r.json())
            .then(data => {
                renderSteps(data.steps);
                document.getElementById('saveOrderBtn').style.display = 'inline-block';
                document.getElementById('resetOrderBtn').style.display = 'inline-block';
            });
    }

    function renderSteps(steps) {
        const container = document.getElementById('stepsContainer');
        container.innerHTML = '';

        if (steps.length === 0) {
            container.innerHTML = '<div class="alert alert-info">В этой цепочке нет шагов.</div>';
            return;
        }

        const list = document.createElement('div');
        list.className = 'list-group';
        list.id = 'stepsList';

        steps.forEach((step, index) => {
            const item = document.createElement('div');
            item.className = 'list-group-item d-flex align-items-center p-3 mb-2 border rounded shadow-sm';
            item.dataset.name = step.name;
            item.style.cursor = 'move';

            let badgeClass = 'bg-secondary';
            if (index === 0) badgeClass = 'bg-success';
            else if (index === steps.length - 1) badgeClass = 'bg-primary';

            let enabledBadge = '';
            let opacityStyle = '';

            if (step.is_enabled === false) {
                enabledBadge = '<span class="badge bg-danger ms-2">Disabled</span>';
                opacityStyle = 'opacity: 0.6;';
                item.style.backgroundColor = '#f8f9fa';
            }

            item.innerHTML = `
            <div class="me-3 text-muted"><i class="bi bi-grip-vertical"></i></div>
            <div class="flex-grow-1" style="${opacityStyle}">
                <div class="fw-bold fs-5">
                    ${step.name} 
                    ${enabledBadge}
                </div>
                <div class="small text-muted">
                    Module: <span class="badge bg-light text-dark border">${step.module_name || 'System'}</span>
                    ${step.state ? `| State: <code>${step.state}</code>` : ''}
                </div>
            </div>
            <div class="text-muted small">#${index + 1}</div>
        `;

            list.appendChild(item);
        });

        container.appendChild(list);

        // Init Drag & Drop
        sortable = new Sortable(list, {
            animation: 150,
            ghostClass: 'bg-light',
            onEnd: function () {
                // Update numbers
                const items = list.querySelectorAll('.list-group-item');
                items.forEach((item, idx) => {
                    item.querySelector('.text-muted.small').innerText = `#${idx + 1}`;
                });
            }
        });
    }

    function saveOrder() {
        if (!currentChain) return;

        const list = document.getElementById('stepsList');
        if (!list) return;

        const steps = Array.from(list.children).map(el => el.dataset.name);

        const btn = document.getElementById('saveOrderBtn');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';

        fetch(`/bots/${botId}/pipelines/${currentChain}/order`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': '{{ csrf_token }}'
            },
            body: JSON.stringify(steps)
        })
            .then(r => r.json())
            .then(data => {
                btn.disabled = false;
                btn.innerHTML = originalText;
                if (data.status === 'success') {
                    // Show toast or alert
                    showToast('Порядок сохранён успешно!');
                } else {
                    alert('Error saving order');
                }
            });
    }

    function resetOrder() {
        if (!currentChain) return;
        if (!confirm('Вы уверены? Это сбросит порядок шагов к умолчанию.')) return;

        const btn = document.getElementById('resetOrderBtn');
        btn.disabled = true;

        fetch(`/bots/${botId}/pipelines/${currentChain}/reset`, {
            method: 'POST',
            headers: {
                'X-CSRF-Token': '{{ csrf_token }}'
            }
        })
            .then(r => r.json())
            .then(data => {
                btn.disabled = false;
                if (data.status === 'success') {
                    showToast('Порядок сброшен к умолчанию');
                    loadChain(currentChain); // Reload
                } else {
                    alert('Error resetting order');
                }
            });
    }

    function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'position-fixed bottom-0 end-0 p-3';
        toast.style.zIndex = 1050;
        toast.innerHTML = `
            <div class="toast show align-items-center text-white bg-success border-0">
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
</script>
{% endblock %}